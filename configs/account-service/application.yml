# ========================================
# Account Service - Config Server 설정
# ========================================
# 공통 설정(common/application.yml)을 상속받고
# Account Service에 특화된 설정만 정의
#
# 역할: 계좌 관리 (생성, 조회, 해지, 잔액 변경)
# 포트: 8081
# DB: account_db
#
# 학습 포인트: 낙관적 락(@Version), 비관적 락(@Lock), 동시성 제어
# ========================================

# ========================================
# 데이터베이스 설정 (공통 설정 오버라이드)
# ========================================
spring:
  datasource:
    # Account Service 전용 DB
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/account_db
    username: ${DB_USERNAME:account}
    password: ${DB_PASSWORD:account}

  # ========================================
  # Kafka 토픽 설정
  # ========================================
  kafka:
    template:
      default-topic: account-events

# ========================================
# Kafka 토픽 정의
# ========================================
kafka:
  topic:
    # ----- 발행 토픽 (Account → 다른 서비스) -----
    # 계좌 생성 완료 이벤트
    account-created: account.created
    # 잔액 변경 이벤트 → Ledger Service
    balance-changed: account.balance.changed
    # 계좌 해지 이벤트
    account-closed: account.closed

    # ----- 구독 토픽 (다른 서비스 → Account) -----
    # 이체 요청 이벤트 (Transfer Service에서 발행) - SAGA
    transfer-debit-requested: transfer.debit.requested
    transfer-credit-requested: transfer.credit.requested
    # 이체 보상 이벤트 (Transfer 실패 시 롤백)
    transfer-debit-rollback: transfer.debit.rollback

# ========================================
# Feign Client 설정
# ========================================
feign:
  client:
    config:
      # User Service 호출 설정 (계좌 소유자 검증)
      user-service:
        connectTimeout: 5000
        readTimeout: 5000
        loggerLevel: basic

# ========================================
# Resilience4j 인스턴스 설정
# ========================================
resilience4j:
  circuitbreaker:
    instances:
      # User Service 호출용 Circuit Breaker
      userServiceCircuitBreaker:
        baseConfig: default
        failureRateThreshold: 50

  retry:
    instances:
      userServiceRetry:
        baseConfig: default
        maxAttempts: 3

# ========================================
# 서비스 고유 설정
# ========================================
account-service:
  # ----- 계좌 설정 -----
  # 계좌번호 생성 규칙 (prefix)
  account-number-prefix: "110"
  # 계좌번호 길이
  account-number-length: 14

  # ----- 잔액 설정 -----
  # 최소 잔액 (원)
  minimum-balance: 0
  # 최대 잔액 (원)
  maximum-balance: 1000000000000
  # 일일 출금 한도 (원)
  daily-withdrawal-limit: 50000000

  # ----- 동시성 제어 설정 -----
  # 낙관적 락 재시도 횟수
  optimistic-lock-retry-count: 3
  # 비관적 락 타임아웃 (밀리초)
  pessimistic-lock-timeout: 5000