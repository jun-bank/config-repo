# ========================================
# Auth Server - Config Server 설정
# ========================================
# 공통 설정(common/application.yml)을 상속받고
# Auth Server에 특화된 설정만 정의
#
# 역할: 인증/인가 (로그인, JWT 발급/검증, 리프레시 토큰)
# 포트: 8086
# DB: auth_db
# ========================================

# ========================================
# 데이터베이스 설정 (공통 설정 오버라이드)
# ========================================
spring:
  datasource:
    # Auth Server 전용 DB
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/auth_db
    username: ${DB_USERNAME:auth}
    password: ${DB_PASSWORD:auth}

  # ========================================
  # Redis 설정 (Primary-Replica)
  # ========================================
  # Write: Primary (6379)
  # Read: Replica (6380) - 우선
  # ========================================
  data:
    redis:
      # Primary 노드 설정
      host: ${REDIS_PRIMARY_HOST:localhost}
      port: ${REDIS_PRIMARY_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 3000ms
      connect-timeout: 3000ms
      lettuce:
        pool:
          max-active: 10
          max-idle: 5
          min-idle: 1
          max-wait: 3000ms

  # ========================================
  # Kafka 토픽 설정
  # ========================================
  kafka:
    template:
      default-topic: auth-events

# ========================================
# Redis Replica 설정 (환경변수)
# ========================================
# RedisPrimaryReplicaConfig에서 사용
# ========================================
redis:
  replica:
    host: ${REDIS_REPLICA_HOST:localhost}
    port: ${REDIS_REPLICA_PORT:6380}

# ========================================
# JWT 설정 (RS256 비대칭키)
# ========================================
# 키 로딩 우선순위:
# 1순위: 환경변수로 키 값 직접 주입 (프로덕션)
# 2순위: 지정된 파일 경로에서 로딩
# 3순위: 기본 디렉토리(data/keys/)에서 로딩
# 4순위: 키가 없으면 자동 생성 (개발용)
# ========================================
jwt:
  # ----- 발급자 및 키 ID -----
  issuer: ${JWT_ISSUER:jun-bank-auth-server}
  key-id: ${JWT_KEY_ID:jun-bank-key-v1}

  # ----- 키 저장 디렉토리 -----
  # 자동 생성 시 저장되는 위치
  key-directory: ${JWT_KEY_DIRECTORY:data/keys}

  # ----- 키 값 직접 주입 (프로덕션) -----
  # Base64 인코딩된 키 값
  private-key: ${JWT_PRIVATE_KEY:}
  public-key: ${JWT_PUBLIC_KEY:}

  # ----- 키 파일 경로 지정 (선택) -----
  private-key-path: ${JWT_PRIVATE_KEY_PATH:}
  public-key-path: ${JWT_PUBLIC_KEY_PATH:}

  # ----- Access Token 설정 -----
  access-token:
    # 만료 시간 (밀리초) - 기본 30분
    expiration: ${JWT_ACCESS_TOKEN_EXPIRATION:1800000}
    # 헤더 이름
    header: Authorization
    # 토큰 접두사
    prefix: Bearer

  # ----- Refresh Token 설정 -----
  refresh-token:
    # 만료 시간 (밀리초) - 기본 7일
    expiration: ${JWT_REFRESH_TOKEN_EXPIRATION:604800000}

# ========================================
# Kafka 토픽 정의
# ========================================
kafka:
  topic:
    # ----- 발행 토픽 (Auth → 다른 서비스) -----
    # 로그인 성공 이벤트
    login-success: auth.login.success
    # 로그인 실패 이벤트
    login-failed: auth.login.failed
    # 로그아웃 이벤트
    logout: auth.logout
    # 토큰 갱신 이벤트
    token-refreshed: auth.token.refreshed

    # ----- 구독 토픽 (다른 서비스 → Auth) -----
    # 회원가입 완료 이벤트 (User Service에서 발행)
    user-created: user.created
    # 회원 탈퇴 이벤트 (관련 토큰 무효화)
    user-deleted: user.deleted

# ========================================
# Feign Client 설정
# ========================================
feign:
  client:
    config:
      # User Service 호출 설정
      user-service:
        connectTimeout: 5000
        readTimeout: 5000
        loggerLevel: full

# ========================================
# Resilience4j 인스턴스 설정
# ========================================
resilience4j:
  circuitbreaker:
    instances:
      # User Service 호출용 Circuit Breaker
      userServiceCircuitBreaker:
        baseConfig: default
        failureRateThreshold: 60

  retry:
    instances:
      userServiceRetry:
        baseConfig: default
        maxAttempts: 3

# ========================================
# Spring Security 설정
# ========================================
# 인증 제외 경로 등 Security 관련 설정
security:
  # 인증 없이 접근 가능한 경로
  permit-all-paths:
    - /api/v1/auth/login
    - /api/v1/auth/register
    - /api/v1/auth/refresh
    - /api/v1/auth/validate
    - /api/v1/auth/public-key
    - /api/v1/auth/public-key/info
    - /.well-known/jwks.json
    - /internal/**
    - /actuator/**
    - /swagger-ui/**
    - /v3/api-docs/**

# ========================================
# 서비스 고유 설정
# ========================================
auth-server:
  # 동시 로그인 허용 수 (0 = 무제한)
  max-concurrent-sessions: 5
  # 리프레시 토큰 재사용 허용 여부
  refresh-token-reuse: false
  # 로그인 실패 시 계정 잠금 임계값
  login-failure-lock-threshold: 5
  # 계정 잠금 시간 (분)
  account-lock-duration-minutes: 30

# ========================================
# Rate Limiting 설정
# ========================================
rate-limit:
  # ----- 로그인 Rate Limit -----
  login:
    # 시간 윈도우 내 최대 요청 수
    max-requests: 50
    # 시간 윈도우 (초) - 10분
    window-seconds: 600
    # 초과 시 차단 시간 (초) - 1시간
    block-seconds: 3600

  # ----- API Rate Limit -----
  api:
    # 시간 윈도우 내 최대 요청 수
    max-requests: 100
    # 시간 윈도우 (초) - 1분
    window-seconds: 60
    # 초과 시 차단 시간 (초) - 10분
    block-seconds: 600