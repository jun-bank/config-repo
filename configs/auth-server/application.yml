# ========================================
# Auth Server - Config Server 설정
# ========================================
# 공통 설정(common/application.yml)을 상속받고
# Auth Server에 특화된 설정만 정의
#
# 역할: 인증/인가 (로그인, JWT 발급/검증, 리프레시 토큰)
# 포트: 8086
# DB: auth_db
# ========================================

# ========================================
# 데이터베이스 설정 (공통 설정 오버라이드)
# ========================================
spring:
  datasource:
    # Auth Server 전용 DB
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/auth_db
    username: ${DB_USERNAME:auth}
    password: ${DB_PASSWORD:auth}

  # ========================================
  # Kafka 토픽 설정
  # ========================================
  kafka:
    template:
      default-topic: auth-events

# ========================================
# JWT 설정
# ========================================
jwt:
  # ----- 비밀 키 -----
  # 운영 환경에서는 반드시 환경변수로 설정!
  # 최소 256비트(32자) 이상 권장
  secret: ${JWT_SECRET:jun-bank-jwt-secret-key-must-be-at-least-256-bits-long-for-security}

  # ----- Access Token 설정 -----
  access-token:
    # 만료 시간 (밀리초) - 기본 30분
    expiration: ${JWT_ACCESS_TOKEN_EXPIRATION:1800000}
    # 헤더 이름
    header: Authorization
    # 토큰 접두사
    prefix: Bearer

  # ----- Refresh Token 설정 -----
  refresh-token:
    # 만료 시간 (밀리초) - 기본 7일
    expiration: ${JWT_REFRESH_TOKEN_EXPIRATION:604800000}

  # ----- 토큰 발급자 -----
  issuer: jun-bank-auth-server

# ========================================
# Kafka 토픽 정의
# ========================================
kafka:
  topic:
    # ----- 발행 토픽 (Auth → 다른 서비스) -----
    # 로그인 성공 이벤트
    login-success: auth.login.success
    # 로그인 실패 이벤트
    login-failed: auth.login.failed
    # 로그아웃 이벤트
    logout: auth.logout
    # 토큰 갱신 이벤트
    token-refreshed: auth.token.refreshed

    # ----- 구독 토픽 (다른 서비스 → Auth) -----
    # 회원가입 완료 이벤트 (User Service에서 발행)
    user-created: user.created
    # 회원 탈퇴 이벤트 (관련 토큰 무효화)
    user-deleted: user.deleted

# ========================================
# Feign Client 설정
# ========================================
feign:
  client:
    config:
      # User Service 호출 설정
      user-service:
        connectTimeout: 5000
        readTimeout: 5000
        loggerLevel: full

# ========================================
# Resilience4j 인스턴스 설정
# ========================================
resilience4j:
  circuitbreaker:
    instances:
      # User Service 호출용 Circuit Breaker
      userServiceCircuitBreaker:
        baseConfig: default
        failureRateThreshold: 60

  retry:
    instances:
      userServiceRetry:
        baseConfig: default
        maxAttempts: 3

# ========================================
# Spring Security 설정
# ========================================
# 인증 제외 경로 등 Security 관련 설정
security:
  # 인증 없이 접근 가능한 경로
  permit-all-paths:
    - /auth/login
    - /auth/register
    - /auth/refresh
    - /actuator/**
    - /swagger-ui/**
    - /v3/api-docs/**

# ========================================
# 서비스 고유 설정
# ========================================
auth-server:
  # 동시 로그인 허용 수 (0 = 무제한)
  max-concurrent-sessions: 3
  # 리프레시 토큰 재사용 허용 여부
  refresh-token-reuse: false
  # 로그인 실패 시 계정 잠금 임계값
  login-failure-lock-threshold: 5
  # 계정 잠금 시간 (분)
  account-lock-duration-minutes: 30